
\documentclass{article}
\usepackage{nips_2018,graphicx}

 \usepackage[english]{babel}   % "babel.sty" + "french.sty"
% \usepackage[english,francais]{babel} % "babel.sty"
% \usepackage{french}                  % "french.sty"
  \usepackage{times}			% ajout times le 30 mai 2003
 
%% --------------------------------------------------------------
%% CODAGE DE POLICES ?
%% Si votre moteur Latex est francise, il est conseille
%% d'utiliser le codage de police T1 pour faciliter la césure,
%% si vous disposez de ces polices (DC/EC)
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc} 
\DeclareUnicodeCharacter{00A0}{~}

%% ==============================================================
% Packages divers (mathématiques, etc.)   
\usepackage{amssymb,amsmath,amscd,amsfonts,amsthm,bbm,mathrsfs,yhmath}
%\usepackage{enumerate}
\usepackage[shortlabels]{enumitem}
% \usepackage{showkeys}
\usepackage{hyperref}

% Example definitions.
% --------------------
\def\x{{\mathbf x}}
\def\L{{\cal L}}

\DeclareMathOperator{\var}{\mathbb Var}
\DeclareMathOperator{\cov}{cov}
\DeclareMathOperator{\rank}{rank}
\DeclareMathOperator{\dom}{dom}
\DeclareMathOperator{\zer}{zer}
\DeclareMathOperator{\aver}{av}
\DeclareMathOperator{\inter}{int}
\DeclareMathOperator{\relint}{ri}
\DeclareMathOperator{\epi}{epi}
\DeclareMathOperator{\graph}{gr}
\DeclareMathOperator{\prox}{prox}
\DeclareMathOperator{\tr}{tr}
\DeclareMathOperator{\support}{supp}
\DeclareMathOperator{\dist}{dist}
\DeclareMathOperator{\lev}{lev}
\DeclareMathOperator{\rec}{rec}
\DeclareMathOperator{\cl}{cl}
\DeclareMathOperator{\co}{co}
\DeclareMathOperator{\clo}{\overline co}
\DeclareMathOperator{\distC}{\mathsf d}
\DeclareMathOperator*{\diag}{diag}
\newcommand{\KL}{\mathop{\mathrm{KL}}\nolimits}


\newcommand{\leftnorm}{\left|\!\left|\!\left|}
\newcommand{\rightnorm}{\right|\!\right|\!\right|}

%\newcommand{\eqdef}{{\stackrel{\text{def}}{=}}} 
\newcommand{\eqdef}{:=} 

\newcommand{\1}{\mathbbm 1}
\newcommand{\bs}{\boldsymbol}

\newcommand{\itpx}{{\mathsf x}}
\newcommand{\sx}{{\mathsf x}}
\newcommand{\sy}{{\mathsf y}}
\newcommand{\sz}{{\mathsf z}}
\newcommand{\sw}{{\mathsf w}}
\newcommand{\sF}{{\mathsf F}}
\newcommand{\sH}{{\mathsf H}}

\newcommand{\ZZ}{\mathbb Z}
\newcommand{\CC}{\mathbb{C}}
\newcommand{\bP}{{{\mathbb P}}} 
\newcommand{\bE}{{{\mathbb E}}} 
\newcommand{\bV}{{{\mathbb V}}} 
\newcommand{\bN}{{{\mathbb N}}} 

% Operators, domains, etc.  
\newcommand{\mA}{{\mathcal A}} 
\newcommand{\mB}{{\mathcal B}} 
\newcommand{\mC}{{\mathcal C}} 
\newcommand{\mD}{{\mathcal D}} 
\newcommand{\mO}{{\mathcal O}} 
\newcommand{\mU}{{\mathcal U}}
\newcommand{\mX}{{\mathcal X}}
\newcommand{\mY}{{\mathcal Y}}
\newcommand{\mZ}{{\mathcal Z}} 
\newcommand{\bmD}{\cl({\mathcal D})} 

\newcommand{\sA}{{\mathsf A}}
\newcommand{\sB}{{\mathsf B}}
\newcommand{\sJ}{{\mathsf J}}
\newcommand{\sX}{{\mathsf X}}
\newcommand{\sG}{{\mathsf G}}
\newcommand{\sY}{{\mathsf Y}}

\newcommand{\maxmon}{{\mathscr M}} 
\newcommand{\Selec}{{\mathfrak S}} 

% Sigma fields
\newcommand{\mcA}{{\mathscr A}} 
\newcommand{\mcB}{{\mathscr B}} 
\newcommand{\mcN}{{\mathscr N}} 
\newcommand{\mcT}{{\mathscr T}} 
\newcommand{\mcI}{{\mathscr I}} 
\newcommand{\mcF}{{\mathscr F}} 
\newcommand{\mcG}{{\mathscr G}} 
\newcommand{\mcX}{{\mathscr X}} 
\newcommand{\cP}{{{\mathcal P}}} 
\newcommand{\cS}{{{\mathcal S}}} 
\newcommand{\cZ}{{{\mathcal Z}}} 
\newcommand{\cF}{{{\mathcal F}}} 
\newcommand{\cG}{{{\mathcal G}}} 
\newcommand{\cM}{{{\mathcal M}}} 
\newcommand{\cD}{{{\mathcal D}}} 
\newcommand{\cE}{{{\mathcal E}}} 
\newcommand{\cL}{{{\mathcal L}}}
\newcommand{\cT}{{{\mathcal T}}} 
\newcommand{\cN}{{{\mathcal N}}} 
\newcommand{\cK}{{{\mathcal K}}} 
\newcommand{\cI}{{{\mathcal I}}} 

% Spaces 
\newcommand{\R}{{{\mathbb R}}} 
\newcommand{\E}{{{\mathbb E}}} 
\newcommand{\kH}{{{\mathcal H}}} 
\newcommand{\F}{{{\mathcal F}}} 
\newcommand{\Hil}{E}                % Hilbert   
\newcommand{\Ban}{E}                % Banach   
\newcommand{\RN}{{{\mathbb R}^N}} 
\newcommand{\bR}{{{\mathbb R}}} 

\newcommand{\m}{\mathfrak{m}}
\newcommand{\toL}{\xrightarrow[]{{\mathcal L}}}
\newcommand{\toweak}{\xrightharpoonup[]{{\mathcal L}}}

\newcommand{\ps}[1]{\langle #1 \rangle}

% 
% Almost sure convergence
\newcommand{\toasshort}{\stackrel{\text{as}}{\to}}
\newcommand{\toaslong}{\xrightarrow[n\to\infty]{\text{a.s.}}}

% Convergence in probability 
\newcommand{\toprobashort}{\,\stackrel{\mathcal{P}}{\to}\,}
\newcommand{\toprobalong}{\xrightarrow[n\to\infty]{\mathcal P}}
%
% Convergence in law 
\newcommand{\todistshort}{{\stackrel{\mathcal{D}}{\to}}}
\newcommand{\todistlong}{\xrightarrow[n\to\infty]{\mathcal D}}

\usepackage[textwidth=2cm, textsize=footnotesize]{todonotes}  
\setlength{\marginparwidth}{1.5cm}               %  this goes with todonotes
\newcommand{\pbnote}[1]{\todo[color=cyan!20]{#1}}
\newcommand{\asnote}[1]{\todo[color=green!20]{#1}}
\newcommand{\whnote}[1]{\todo[color=magenta]{#1}}
\newcommand{\wh}[1]{{\color{red} #1}}

%Moreau
\newcommand{\my}{{{\nabla ^\gamma g}}}
\newcommand{\myn}{{{\nabla ^{\gamma_{n+1}} g}}}
%% ==============================================================

\theoremstyle{definition}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{definition}{Definition}
\newtheorem{remark}{Remark}
\newtheorem{condition}{Condition}
\newtheorem{assumption}{Assumption}
\newtheorem{example}{Example}
\newtheorem{remark}[theorem]{Remark}

\title{MMD Flow}

\begin{document}
\maketitle


\begin{abstract} 

\end{abstract}

\section{Notations}
$p$ target distribution. Let $k$ a kernel and $\kH$ its RKHS
\begin{equation}
    MMD(p,q)=\sup_{f \in \kH,  \|f\|_{\kH}\le 1} \E_{X \sim p}[f(X)]-\E_{Y \sim q}[f(Y)]=\|\E_{p}[k(X,.)] + \E_{q}[k(Y,.)]\|_{\kH}
\end{equation}
We will consider a flow $(q_t)_{t>0}$ and denote $f_t=\E_{p}[k(X,.)] + \E_{q_t}[k(Y,.)]$. In this case, $MMD^2(p,q_t)=\|f_t\|^2_{\kH}$.


\section{Background}

\textit{Lyapunov functional} (or "free energy" or "entropy") $\F$  \citep{villani2004trend}:
\begin{equation}
    \F(q)=\int U(q(x)) q(x)dx + \int V(x)q(x)dx + \int W(x,y)q(x)q(y)dxdy
\end{equation}
where 
The formal gradient flow equation associated to this functional can be written:
\begin{equation}
    \frac{\partial q}{\partial t}= div( q \nabla \frac{\partial \F}{\partial q}) \quad x \in \R^d , t>0
\end{equation}
And the dissipation of entropy is defined as %see  http://wwwf.imperial.ac.uk/~jcarrill/RICAM/CharlaRICAM2014-1.pdf
\begin{align}
    &        \frac{d \F(q)}{dt} =-D(q) \quad \text{ with } D(q)= \int |\xi|^2 q(x)dx\\
    &\text{ and } \xi= \nabla (U'(q) + V + W * q)= \nabla \frac{\partial \F}{\partial q}
\end{align}

\begin{remark} When $\F$ is the KL divergence $KL(q,p)=\int log(\frac{q(x)}{p(x)}q(x)dx$, $\F(q)=\int U(q(x))q(x)dx + \int V(x) q(x)dx$ with $U(q(x))=q(x)log(q(x))$ and $V(x)=-log(p(x))$. In this case, $\nabla \frac{\partial \F}{\partial q}= \nabla log(\frac{q}{p})$.
\end{remark}

\section{MMD flow}

We define the potential energy (also called confinement energy) $V$ and interaction energy $W$ as follows:
\begin{align}
    V(X)&=-\int 2 k(X,x')p(x')\\
    W(X,Y)&=k(X,Y)
\end{align}
We have $MMD^2(p,q)=C+ \int V(x) q(x)dx + \int W(x,x')q(x)q(x')$. $MMD$ can thus be written as a \textit{Lyapunov functional} (or "free energy" or "entropy") $\F$.
In the case where $\F=MMD^2$:
\begin{align}
        \nabla \frac{\partial \F}{\partial q}&= \nabla \frac{\partial \|f_t\|^2_{\kH}}{\partial q_t}\\
        &=2 \nabla \langle \frac{\partial f_t}{\partial q_t}, f_t \rangle_{\kH}\\
        &=2 \nabla \langle \frac{\partial \E_{q_t}[k(X,.)]}{\partial q_t}, f_t \rangle_{\kH}\\
        &=2 \nabla \langle k(X,.), f_t \rangle_{\kH}\\
        &= 2 \nabla f_t(x)
\end{align}
where $\nabla f_t(Y)= \E_{X \sim q_t}[\nabla_{Y}k(X,Y)] -  \E_{X \sim p}[\nabla_{Y}k(X,Y)]$. So the dissipation of MMD is given by:  
\begin{equation}
    \frac{d MMD^2(q_t, p)}{dt}=-2 \E_{X \sim q_t}[\|\nabla f_t(X)\|^2]
\end{equation}

\begin{remark}
For $\F=KL$, we would obtain $-\E_{X \sim q_t}[\|\nabla log(\frac{q_t}{p}(X))\|^2]$
\end{remark}



\section{Lambda displacement convexity of the MMD}


Let $\mu$ and $\nu$ be two probability densities on $\mathbb{R}^{d}$,
we would like to show that $\nu\mapsto MMD^{2}(\mu,\nu)$ is a convex
functional for $\nu$ that are close enough to $\mu$ in the Wasserstein
sense. Here the notion of convexity should be understood in the following
sense:
\begin{definition}
(displacement convexity \cite{Villani:2004} Definition 1 ). Let $\mu$
and $\nu$ be two probabilities densities. There exists a $\mu-a.e.$
unique gradient of a convex function ,$\nabla\phi$, such that $\nu$
is equal to $\nabla\phi_{\#}\mu$ and one can define $\rho_{t}=((1-t)Id+t\nabla\phi)_{\#}\mu$
for $0\leq t\leq1$. We say that a functional $\nu\mapsto\mathcal{F}(\nu)$
is displacement convex if 
\[
t\mapsto\mathcal{F}(\rho_{t})
\]
 is convex for any $\mu$ and $\nu$.Moreover, we say that $\mathcal{F}$
is convex in a neighborhood of $\mu$ if there exists a radius $r>0$
such that the above property holds for any $\nu$ with $W_{2}(\mu,\nu)\leq r$
.
\end{definition}
%
\begin{definition}
($\Lambda$-convexity \cite{Villani:2009} Definition 16.4). Let $(\mu,v)\mapsto\Lambda(\mu,v)$
be a function that defines for each probability distribution $\mu$
a quadratic form on the set of square integrable vectors valued functions
$v$ , i.e: $v\in L_{2}(\mathbb{R}^{d},\mathbb{R}^{d},\mu)$ . We
further assume that:
\[
\inf_{\mu,v}\frac{\Lambda(\mu,v)}{\Vert v\Vert_{L_{2}(\mu)}^{2}}>-\infty.
\]

We say that a functional $\mu\mapsto\mathcal{F}(\mu)$ is $\Lambda$-convex
if for any $\mu$ and $\nu$ and a minimizing geodesic $\text{\ensuremath{\rho_{t}}}$
between $\mu$ and $\nu$ with velocity vector field $v_{t}$, i.e:
$\partial_{t}\rho_{t}+div(\rho_{t}v_{t})=0;\rho_{0}=\mu;\rho_{1}=\nu$
the following holds:
\end{definition}
\[
\frac{d^{2}\mathcal{F}(\rho_{t})}{dt^{2}}\geq\Lambda(\rho_{t},v_{t})\qquad\forall t\in[0,1].
\]

\begin{proposition}
\label{prop:lambda_convexity}$\nu\mapsto MMD^{2}(\mu,\nu)$ is $\text{\ensuremath{\Lambda_{\mu}}}$-convex
with $\Lambda_{\mu}$ given by:
\begin{equation}
\Lambda_{\mu}(\rho,v)=\langle v,(C_{\rho}-\lambda MMD(\mu,\rho)I)v\rangle_{L_{2}(\rho)}\label{eq:Lambda}
\end{equation}

where $C_{\rho}$ is the operator defined by:
\[
(C_{\rho}v)(x)=\int\nabla_{x}\nabla_{x'}k(x,x')v(x')d\rho(x')
\]

and $\lambda=\sup_{x,x'\in\mathbb{\mathbb{R}^{d}}}\Vert Hk(x,x')\Vert_{op}$
where $Hk(x,x')$ is an $\mathbb{R}^{d^{2}}\times\mathbb{R}^{d^{2}}$
matrix whose entries are given by $\partial_{x_{i}}\partial_{x_{j}}\partial_{x'_{i}}\partial_{x'j}k(x,x')$.
\end{proposition}
%
\begin{proof}
To prove that $\nu\mapsto MMD^{2}(\mu,\nu)$ $\Lambda_{\mu}$-convex
we need to compute the second derivative $\frac{d^{2}}{dt^{2}}MMD^{2}(\mu,\rho_{t})$
where $\rho_{t}$ is a minimizing geodesic between two probability
distributions $\nu_{0}$ and $\nu_{1}$. When $\nu_{0}$ and $\nu_{1}$
both have a density, there exists a convex function such that $\rho_{t}=(1-t)Id+t\nabla\phi)_{\#}\nu_{0}:=(\pi_{t})_{\#}\nu_{0}$
.We start by computing the first derivative:
\[
\frac{dMMD^{2}(\mu,\rho_{t})}{dt}=2\langle f_{t},\frac{df_{t}}{dt}\rangle_{\mathcal{H}}
\]
where $f_{t}=\rho_{t}(k(x,.))-\mu(k(x,.))$. Using the definition
of $\rho_{t}=(1-t)Id+t\nabla\phi)_{\#}\mu$ it follows that:
\[
\frac{df_{t}}{dt}=\int(\nabla\phi(x)-x).\nabla k(\pi_{t}(x),.)\nu_{0}(x)dx
\]
hence:
\[
\frac{dMMD^{2}(\mu,\rho_{t})}{dt}=2\int(\nabla\phi(x)-x).\nabla f_{t}(\pi_{t}(x))\nu_{0}(x)dx
\]
Now the second derivative is given by:
\begin{align*}
\frac{d^{2}MMD^{2}(\mu,\rho_{t})}{dt^{2}}= & \int(\nabla\phi(x)-x).Hf_{t}(\pi_{t}(x))(\nabla\phi(x)-x)\nu_{0}(x)dx\\
 & +\int(\nabla\phi(x)-x).\nabla_{1}\nabla_{2}k(\pi_{t}(x),\pi_{t}(x'))(\nabla\phi(x')-x')\nu_{0}(x)\nu_{0}(x')dxdx'
\end{align*}
Here $\nabla_{1}\nabla_{2}k(x,x')$ is the matrix whose components
are given by $\langle\partial_{i}k(x,.),\partial_{j}k(x,.)\rangle$
for $1\leq i,j\leq d$, and $Hf_{t}$ is the hesssian of $f_{t}$
and its components are also given by:
\[
(Hf_{t}(x))_{i,j}=\langle f_{t},\partial_{i}\partial_{j}k(x,.)\rangle.
\]
Denoting by $h(x):=\nabla\phi(x)-x$ it follows that:
\begin{align*}
\frac{d^{2}MMD^{2}(\mu,\rho_{t})}{dt^{2}}= & \langle f_{t},\int\sum_{i,j}h_{i}(x)h_{j}(x)\partial_{i}\partial_{j}k(\pi_{t}(x),.)\nu_{0}(x)dx\rangle\\
 & +\Vert\int\sum_{i}h_{i}(x)\partial_{i}k(\pi_{t}(x),.)\nu_{0}(x)dx\Vert^{2}
\end{align*}
Now we use Cauchy-Schwarz inequality for the first term to get:
\begin{align*}
\frac{d^{2}MMD^{2}(\mu,\rho_{t})}{dt^{2}}\geq & -\Vert f_{t}\Vert_{\mathcal{H}}\Vert\int\sum_{i,j}h_{i}(x)h_{j}(x)\partial_{i}\partial_{j}k(\pi_{t}(x),.)\nu_{0}(x)dx\Vert_{\mathcal{H}}\\
 & +\Vert\int\sum_{i}h_{i}(x)\partial_{i}k(\pi_{t}(x),.)\nu_{0}(x)dx\Vert^{2}.
\end{align*}
After aplying a change of variables $x=\pi_{t}(y)$ one recovers the
velocity vector $v_{t}$ instead of $h$: 
\begin{align*}
\frac{d^{2}MMD^{2}(\mu,\rho_{t})}{dt^{2}}\geq & -\Vert f_{t}\Vert_{\mathcal{H}}\Vert\int\sum_{i,j}v_{t}^{i}(x)v_{t}^{j}(x)\partial_{i}\partial_{j}k(x,.)\rho_{t}(x)dx\Vert_{\mathcal{H}}\\
 & +\Vert\int\sum_{i}v_{t}^{i}(x)\partial_{i}k(x,.)\rho_{t}(x)dx\Vert^{2}.
\end{align*}

One can further note that:
\[
\Vert\int\sum_{i,j}v_{t}^{i}(x)v_{t}^{j}(x)\partial_{i}\partial_{j}k(x,.)\rho_{t}(x)dx\Vert_{\mathcal{H}}\leq\lambda\Vert v_{t}\Vert_{L_{2}(\rho_{t})}^{2}
\]

and that 
\begin{align*}
\Vert\int\sum_{i}v_{t}^{i}(x)\partial_{i}k(x,.)\rho_{t}(x)dx\Vert^{2} & =\int v_{t}(x)^{T}\int\nabla_{1}\nabla_{2}k(x,x')v_{t}(x')\rho_{t}(x')dx'dx.\\
 & =\langle v_{t},C_{\rho_{t}}v_{t}\rangle_{L_{2}(\rho_{t})}
\end{align*}

Hence we have shown that 
\[
\frac{d^{2}MMD^{2}(\mu,\rho_{t})}{dt^{2}}\geq\langle v_{t},(C_{\rho_{t}}-\lambda MMD(\mu,\rho_{t})I)v_{t}\rangle_{L_{2}(\rho_{t})}=\Lambda_{\mu}(\rho_{t},v_{t})
\]
\end{proof}
%
It is worth noting that $\nu_{0}=\mu$ and at time $t=0$ we have
that $MMD(\mu,\rho_{0})=0$ and hence we get:
\[
\frac{d^{2}MMD^{2}(\mu,\rho_{t})}{dt^{2}}\vert_{t=0}=\langle v_{t},C_{\rho_{t}}v_{t}\rangle_{L_{2}(\rho_{t})}\geq0.
\]
This shows that $\nu\mapsto MMD^{2}(\mu,\nu)$ has a non-negative
hessian at $\mu$ which is not surprising since $\mu$ is the global
minimum of this functional.


\subsubsection*{References}
\renewcommand\refname{\vskip -1cm}
\bibliographystyle{apalike}
\bibliography{biblio}

\end{document}